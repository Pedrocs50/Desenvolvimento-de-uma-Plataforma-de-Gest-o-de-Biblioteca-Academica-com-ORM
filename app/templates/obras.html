{% extends 'base.html' %}

{% block header %}
<div class="flex justify-between items-center">
    <h1 class="text-3xl font-bold tracking-tight text-gray-900">
        {% if current_user.tipo == 'admin' %}Gerenciar Obras{% else %}Consultar Obras{% endif %}
    </h1>
    {% if current_user.is_authenticated and current_user.tipo == 'admin' %}
    <a href="{{ url_for('main.add_obra') }}" class="inline-flex items-center gap-x-2 rounded-md bg-indigo-600 px-3.5 py-2.5 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-600">
        <svg class="-ml-0.5 h-5 w-5" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" /></svg>
        Nova Obra
    </a>
    {% endif %}
</div>
{% endblock %}

{% block content %}
<!-- SEÇÃO DE FILTROS E BUSCA -->
<div class="mb-6 bg-white p-4 rounded-lg shadow">
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="md:col-span-2">
            <label for="busca" class="block text-sm font-medium text-gray-700">Buscar por Título, Gênero ou Ano</label>
            <input type="search" id="busca" name="busca" placeholder="Digite para buscar..." class="mt-1 block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm">
        </div>
        <div>
            <label for="filtro_tipo" class="block text-sm font-medium text-gray-700">Filtrar por Tipo</label>
            <select id="filtro_tipo" name="filtro_tipo" class="mt-1 block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm">
                <option value="">Todos os Tipos</option>
                <option value="livro">Livro</option>
                <option value="tese">Tese</option>
                <option value="dissertacao">Dissertação</option>
            </select>
        </div>
    </div>
</div>

<!-- Tabela de Resultados -->
<div class="overflow-x-auto bg-white rounded-lg shadow">
    <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
            <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Título</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Gênero</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ano</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Disponibilidade</th>
                <th class="relative px-6 py-3"><span class="sr-only">Ações</span></th>
            </tr>
        </thead>
        <tbody id="obras-tbody" class="bg-white divide-y divide-gray-200">
            <!-- O JavaScript vai popular aqui -->
        </tbody>
    </table>
</div>

<script>
const tbody = document.getElementById('obras-tbody');
const searchInput = document.getElementById('busca');
const tipoSelect = document.getElementById('filtro_tipo');
const userTipo = "{{ current_user.tipo }}";

async function fetchAndRenderObras() {
    const termo = searchInput.value;
    const tipo = tipoSelect.value;
    const url = `{{ url_for('main.search_obras_api') }}?termo=${encodeURIComponent(termo)}&tipo=${encodeURIComponent(tipo)}`;

    try {
        const res = await fetch(url);
        const obras = await res.json();
        
        tbody.innerHTML = '';

        if (obras.length === 0) {
            tbody.innerHTML = `<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">Nenhuma obra encontrada.</td></tr>`;
            return;
        }

        obras.forEach(obra => {
            const disponivelBadge = obra.tem_exemplares_disponiveis ?
                `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">Disponível</span>` :
                `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">Indisponível</span>`;

            let acoes = '';
            if (userTipo === 'aluno' && !obra.tem_exemplares_disponiveis) {
                acoes = `
                    <form action="/obra/${obra.id}/reservar" method="POST">
                        <button type="submit" class="text-indigo-600 hover:text-indigo-900">Reservar</button>
                    </form>
                `;
            }
            
            const tituloHTML = userTipo === 'admin' ?
                `<a href="/obra/${obra.id}/detalhes" class="text-indigo-600 hover:text-indigo-900 font-semibold">${obra.titulo}</a>` :
                obra.titulo;

            const row = `
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${tituloHTML}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${obra.genero || '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${obra.ano_publicacao || '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 capitalize">${obra.tipo_obra}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${disponivelBadge}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">${acoes}</td>
                </tr>
            `;
            tbody.innerHTML += row;
        });
    } catch (error) {
        console.error("Erro ao buscar obras:", error);
        tbody.innerHTML = `<tr><td colspan="6" class="px-6 py-4 text-center text-red-500">Erro ao carregar os dados.</td></tr>`;
    }
}

searchInput.addEventListener('keyup', fetchAndRenderObras);
tipoSelect.addEventListener('change', fetchAndRenderObras);
document.addEventListener('DOMContentLoaded', fetchAndRenderObras);
</script>
{% endblock %}